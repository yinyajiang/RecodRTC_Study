<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <button id="btn-start-recording">Start Recording</button>
    <button id="btn-stop-recording" disabled>Stop Recording</button>
    <button id="btn-download-recording" disabled>Download</button>

    <hr>
    <div>
        <audio controls autoplay playsinline></audio>
        <video controls autoplay playsinline></video>
    </div>

    <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>

    <script> //utils
        function isEmptyObj(obj) {
            return !obj || Object.keys(obj).length === 0;
        }
        function SaveToDisk(fileURL, ext, prefix = "redord-") {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0'); // 月份从0开始，需要加1
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;

            const fileName = prefix + formattedDateTime + '.' + ext;

            // for non-IE
            if (!window.ActiveXObject) {
                let save = document.createElement('a');
                save.href = fileURL;
                save.download = fileName || 'unknown';
                save.style = 'display:none;opacity:0;color:transparent;';
                (document.body || document.documentElement).appendChild(save);
                if (typeof save.click === 'function') {
                    save.click();
                } else {
                    save.target = '_blank';
                    let event = document.createEvent('Event');
                    event.initEvent('click', true, true);
                    save.dispatchEvent(event);
                }
                (window.URL || window.webkitURL).revokeObjectURL(save.href);
            }
            // for IE
            else if (!!window.ActiveXObject && document.execCommand) {
                let _window = window.open(fileURL, '_blank');
                _window.document.close();
                _window.document.execCommand('SaveAs', true, fileName || fileURL)
                _window.close();
            }
        }

        function IsNotWindows() {
            return navigator.platform && navigator.platform.toString().toLowerCase().indexOf('win') === -1
        }

        function ReplaceAudioEle(src) {
            let oldAudio = document.querySelector('audio');
            var newAudio = document.createElement('audio');
            newAudio.controls = true;
            if (oldAudio) {
                newAudio.autoplay = oldAudio.autoplay;
            } else {
                newAudio.autoplay = false;
            }
            if (src) {
                newAudio.src = src;
            }
            var parentNode = oldAudio.parentNode;
            parentNode.innerHTML = '';
            parentNode.appendChild(newAudio);
            return newAudio;
        }

        function ClickEle(el) {
            el.disabled = false; // make sure that element is not disabled
            var evt = document.createEvent('Event');
            evt.initEvent('click', true, true);
            el.dispatchEvent(evt);
        }

        function IsEdge() {
            if (typeof window.__isEdge !== 'undefined') {
                return window.__isEdge;
            }
            window.__isEdge = navigator.userAgent.indexOf('Edge') !== -1 && (!!navigator.msSaveOrOpenBlob || !!navigator.msSaveBlob);
            return window.__isEdge;
        }

        function IsSafari() {
            if (typeof window.__isSafari !== 'undefined') {
                return window.__isSafari;
            }
            window.__isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            return window.__isSafari;
        }
    </script>


    <script>
        class MediaRecorderApp {
            constructor(captures, selector, isAutoAttachSelectorsListeners) {
                if (isEmptyObj(captures)) {
                    alert('No captures found.');
                    return;
                }
                this._captures = captures;
                if (selector && selector.start) {
                    this._start_btn = document.querySelector(selector.start);
                    this._enableBtn(this._start_btn, true);
                }
                if (selector && selector.stop) {
                    this._stop_btn = document.querySelector(selector.stop);
                    this._enableBtn(this._stop_btn, false);
                }
                if (selector && selector.download) {
                    this._download_btn = document.querySelector(selector.download);
                    this._enableBtn(this._download_btn, false);
                }
                if (selector && selector.videoPreview) {
                    this._videoPreview = document.querySelector(selector.videoPreview);
                }
                if (selector && selector.videoStopPreview) {
                    this._videoStopPreview = document.querySelector(selector.videoStopPreview);
                }
                if (selector && selector.audioStopPreview) {
                    this._audioStopPreview = document.querySelector(selector.audioStopPreview);
                }

                if (isAutoAttachSelectorsListeners) {
                    if (this._start_btn) {
                        this._start_btn.addEventListener('click', this.start.bind(this));
                    }
                    if (this._stop_btn) {
                        this._stop_btn.addEventListener('click', this.stop.bind(this));
                    }
                    if (this._download_btn) {
                        this._download_btn.addEventListener('click', this.download.bind(this));
                    }
                }
            }

            onStop(callback) {
                this._onStopCallback = callback;
            }
            onDownload(callback) {
                this._onDownloadCallback = callback;
            }
            onStart(callback) {
                this._onStartCallback = callback;
            }

            async start() {
                if (typeof navigator.mediaDevices === 'undefined' || !navigator.mediaDevices.getUserMedia) {
                    alert('This browser does not supports WebRTC getUserMedia API.');
                    return;
                }
                this._blobURL = null;
                this._ext = "mp3"
                this.streams = await this._captureStreams();
                let options = {};
                if (this.streams.isVideo) {
                    this._ext = "mp4"
                    options = Object.assign(options, {
                        type: 'video',
                        mimeType: 'video/mp4',
                    });
                } else {
                    options = Object.assign(options, this._audioRecorderOptions());
                }

                if (this.recorder) {
                    this.recorder.destroy();
                    this.recorder = null;
                }
                this._enableBtn(this._start_btn, false);
                this._enableBtn(this._stop_btn, true);

                if (this._videoPreview && this.streams.isVideo) {
                    this._videoPreview.style.display = 'block';
                    this._videoPreview.src = this._videoPreview.srcObject = null;
                    this._videoPreview.muted = true;
                    this._videoPreview.volume = 0;
                    this._videoPreview.srcObject = this.streams;
                }
                if (this._onStartCallback) {
                    this._onStartCallback(this.streams);
                }
                this.recorder = RecordRTC(this.streams, options);
                this.recorder.startRecording();
            }

            stop() {
                this.recorder.stopRecording((blobURL) => {
                    const isVideo = this.streams.isVideo;
                    this._blobURL = blobURL;

                    if (isVideo) {
                        if (this._videoPreview) {
                            this._videoPreview.src = this._videoPreview.srcObject = null;
                            this._videoPreview.style.display = 'none';
                        }
                        if (this._videoStopPreview) {
                            this._videoStopPreview.style.display = 'block';
                            this._videoStopPreview.src = this._videoStopPreview.srcObject = null;
                            this._videoStopPreview.muted = false;
                            this._videoStopPreview.volume = 1;
                            this._videoStopPreview.src = this._blobURL;
                        }
                    } else {
                        if (this._audioStopPreview) {
                            this._audioStopPreview.style.display = 'block';
                            this._audioStopPreview.src = this._audioStopPreview.src;
                            this._audioStopPreview.muted = false;
                            this._audioStopPreview.volume = 1;
                            this._audioStopPreview.src = this._blobURL;
                        }
                    }

                    if (this._onStopCallback) {
                        this._onStopCallback(isVideo, this._blobURL);
                    }
                    this._close();
                    this._enableBtn(this._start_btn, true);
                    this._enableBtn(this._stop_btn, false);
                    this._enableBtn(this._download_btn, true);
                });
            }

            download() {
                if (!this._blobURL) {
                    return;
                }
                SaveToDisk(this._blobURL, this._ext);
                if (this._onDownloadCallback) {
                    this._onDownloadCallback();
                }
            }

            _audioRecorderOptions() {
                let audioOptions = {
                    type: 'audio',
                    numberOfAudioChannels: IsEdge() ? 1 : 2,
                    checkForInactiveTracks: true,
                    bufferSize: 16384
                };
                if (IsSafari() || IsEdge()) {
                    audioOptions.recorderType = StereoAudioRecorder;
                }
                if (IsNotWindows()) {
                    audioOptions.sampleRate = 48000; // or 44100 or remove this line for default
                }
                if (IsSafari()) {
                    audioOptions.sampleRate = 44100;
                    audioOptions.bufferSize = 4096;
                    audioOptions.numberOfAudioChannels = 2;
                }
                return audioOptions;
            }

            _enableBtn(btn, enable) {
                if (btn) btn.disabled = !enable;
            }

            async _captureStreams() {
                try {
                    let streams = {};
                    if (this._captures.camera && this._captures.microphone) {
                        streams = await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
                        streams.camera = streams
                        streams.isVideo = true
                    } else if (this._captures.camera) {
                        streams = await navigator.mediaDevices.getUserMedia({ video: true })
                        streams.camera = streams
                        streams.isVideo = true
                    } else if (this._captures.microphone) {
                        streams = await navigator.mediaDevices.getUserMedia({
                            audio: IsEdge() ? true : {
                                echoCancellation: false
                            }
                        })
                        streams.microphone = streams
                    }
                    return streams;
                } catch (e) {
                    alert('Error capturing streams: ' + e.message);
                    console.error(e);
                }

            }
            _close() {
                if (!this.streams) {
                    return;
                }
                if (this.streams.camera) {
                    this.streams.camera.stop();
                }
                if (this.streams.microphone) {
                    this.streams.microphone.stop();
                }
                this.streams = null;
                this.recorder.destroy();
                this.recorder = null;
            }
        };

        const app = new MediaRecorderApp(
            {
                //camera: true,
                microphone: true
            },
            {
                start: '#btn-start-recording',
                stop: '#btn-stop-recording',
                download: '#btn-download-recording',
                videoPreview: 'video',
                videoStopPreview: 'video',
                audioStopPreview: 'audio'
            },
            true,
        );


        app.onStart((streams) => {

        });
        app.onStop((isVideo, blob) => { });
    </script>
</body>

</html>