<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <button id="btn-start-recording">Start Recording</button>
    <button id="btn-stop-recording" disabled>Stop Recording</button>
    <button id="btn-pause-recording" disabled>Pause Recording</button>
    <button id="btn-resume-recording" disabled>Resume Recording</button>
    <button id="btn-download-recording" disabled>Download</button>

    <hr>
    <div>
        <audio controls autoplay playsinline></audio>
        <video controls autoplay playsinline style="width: 200px; height: 200px;"></video>
    </div>

    <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>

    <script> //utils
        function IsEdge() {
            if (typeof window.__isEdge !== 'undefined') {
                return window.__isEdge;
            }
            window.__isEdge = navigator.userAgent.indexOf('Edge') !== -1 && (!!navigator.msSaveOrOpenBlob || !!navigator.msSaveBlob);
            return window.__isEdge;
        }

        function IsSafari() {
            if (typeof window.__isSafari !== 'undefined') {
                return window.__isSafari;
            }
            window.__isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            return window.__isSafari;
        }

        class MediaRecorderApp {
            constructor(options) {
                const captures = options.captures;
                const selector = options.selectors;
                const setQuerySelector = (btnname, selectorname, enable = null) => {
                    if (btnname && selector && selectorname && selector[selectorname]) {
                        this[btnname] = document.querySelector(selector[selectorname]);
                        if (typeof enable === 'boolean') {
                            this._enableBtn(this[btnname], enable);
                        }
                    }
                }
                setQuerySelector('_start_btn', 'start', true);
                setQuerySelector('_stop_btn', 'stop', false);
                setQuerySelector('_download_btn', 'download');
                setQuerySelector('_pause_btn', 'pause', false)
                setQuerySelector('_resume_btn', 'resume', false)
                setQuerySelector('_videoRecordingPreview', 'videoRecordingPreview');
                setQuerySelector('_videoFinishPreview', 'videoFinishPreview');
                setQuerySelector('_audioFinishPreview', 'audioFinishPreview');


                this._captures = captures;
                if (typeof options.notAttachSelectorsListeners === 'boolean' && !options.notAttachSelectorsListeners) {
                    if (this._start_btn) {
                        this._start_btn.addEventListener('click', this.start.bind(this));
                    }
                    if (this._stop_btn) {
                        this._stop_btn.addEventListener('click', this.stop.bind(this));
                    }
                    if (this._download_btn) {
                        this._download_btn.addEventListener('click', this.download.bind(this));
                    }
                    if (this._pause_btn) {
                        this._pause_btn.addEventListener('click', this.pause.bind(this));
                    }
                    if (this._resume_btn) {
                        this._resume_btn.addEventListener('click', this.resume.bind(this));
                    }
                }
            }

            onStop(callback) {
                if (!this._onStopCallbacks) this._onStopCallbacks = [];
                this._onStopCallbacks.push(callback);
            }
            onDownload(callback) {
                if (!this._onDownloadCallbacks) this._onDownloadCallbacks = [];
                this._onDownloadCallbacks.push(callback);
            }
            onStart(callback) {
                if (!this._onStartCallbacks) this._onStartCallbacks = [];
                this._onStartCallbacks.push(callback);
            }
            onPause(callback) {
                if (!this._onPauseCallbacks) this._onPauseCallbacks = [];
                this._onPauseCallbacks.push(callback);
            }
            onResume(callback) {
                if (!this._onResumeCallbacks) this._onResumeCallbacks = [];
                this._onResumeCallbacks.push(callback);
            }
            async start() {
                this._stop = false;
                this._blobURL = null;
                this._ext = "mp4"
                this._close();
                this._enableBtn(this._start_btn, false);
                this._enableBtn(this._stop_btn, true);
                this._enableBtn(this._download_btn, false);
                this._enableBtn(this._pause_btn, true);
                this._enableBtn(this._resume_btn, false);

                this._recordStreams = await this._captureRecordStreams(() => this.stop());

                let options = {};
                if (this._recordStreams.isVideo) {
                    this._ext = "mp4"
                    options = Object.assign(options, {
                        type: 'video',
                        mimeType: 'video/mp4',
                    });
                } else {
                    this._ext = "mp3"
                    let audioOptions = {
                        type: 'audio',
                    };
                    if (IsSafari() || IsEdge()) {
                        audioOptions.recorderType = StereoAudioRecorder;
                        audioOptions.numberOfAudioChannels = IsEdge() ? 1 : 2;
                    }
                    options = Object.assign(options, audioOptions);
                }


                if (this._recordStreams.isVideo) {
                    options.previewStream = (preview) => this._playSrc(this._videoRecordingPreview, preview, 0);
                }
                if (this._onStartCallbacks) this._onStartCallbacks.forEach(callback => callback(this._recordStreams));
                this._recorder = RecordRTC(this._recordStreams, options);
                this._recorder.startRecording();
            }

            stop() {
                if (this._stop) return;
                this._stop = true;
                this._recorder.stopRecording((blobURL) => {
                    const isVideo = this._recordStreams.isVideo;
                    this._blobURL = blobURL;
                    if (isVideo) {
                        if (this._videoRecordingPreview) {
                            this._videoRecordingPreview.src = this._videoRecordingPreview.srcObject = null;
                            this._videoRecordingPreview.style.display = 'none';
                        }
                        this._playSrc(this._videoFinishPreview, this._blobURL, 1);
                    } else {
                        this._playSrc(this._audioFinishPreview, this._blobURL, 1);
                    }
                    if (this._onStopCallbacks) {
                        this._onStopCallbacks.forEach(callback => callback(isVideo, this._blobURL));
                    }
                    this._close();
                    this._enableBtn(this._start_btn, true);
                    this._enableBtn(this._stop_btn, false);
                    this._enableBtn(this._download_btn, true);
                });
            }

            download() {
                if (!this._blobURL) return;
                this._saveURLToDisk(this._blobURL, this._ext);
                if (this._onDownloadCallbacks) this._onDownloadCallbacks.forEach(callback => callback(this._blobURL));
            }

            pause() {
                if (this._recorder) {
                    this._recorder.pauseRecording();
                    this._enableBtn(this._pause_btn, false);
                    this._enableBtn(this._resume_btn, true);
                    if (this._onPauseCallbacks) this._onPauseCallbacks.forEach(callback => callback());
                }
            }

            resume() {
                if (this._recorder) {
                    this._recorder.resumeRecording();
                    this._enableBtn(this._pause_btn, true);
                    this._enableBtn(this._resume_btn, false);
                    if (this._onResumeCallbacks) this._onResumeCallbacks.forEach(callback => callback());
                }
            }

            _enableBtn(btn, enable) {
                if (btn) btn.disabled = !enable;
            }

            _playSrc(ele, src, volume) {
                if (!ele) return;
                if (ele.style.display === 'none') {
                    ele.style.display = 'block';
                }
                ele.src = this._videoRecordingPreview.srcObject = null;
                if (volume) {
                    ele.muted = false;
                    ele.volume = volume;
                } else {
                    ele.muted = true;
                }
                if (typeof src === 'string') {
                    ele.src = src;
                } else {
                    ele.srcObject = src;
                }
            }

            async _captureRecordStreams(streamStopCallback) {
                try {
                    let hasCaptureSystemAudio = false;
                    let hasCaptureMicrophone = false;
                    let streams = [];
                    if (this._captures.screen) {
                        const screen = await this._getDisplayMedia({ video: true, audio: this._captures.systemAudio });
                        streams.screen = screen;
                        streams.isVideo = true;
                        streams.push(screen);
                        hasCaptureSystemAudio = this._captures.systemAudio;

                        const keepStreamActive = document.createElement('video');
                        keepStreamActive.muted = true;
                        keepStreamActive.srcObject = screen;
                        keepStreamActive.style.display = 'none';
                        (document.body || document.documentElement).appendChild(keepStreamActive);
                        this.onStop(() => {
                            keepStreamActive.srcObject = null;
                            (document.body || document.documentElement).removeChild(keepStreamActive);
                        })
                    }
                    if (!hasCaptureSystemAudio && this._captures.systemAudio) {
                        const systemAudio = await this._getDisplayMedia({ audio: true });
                        streams.systemAudio = systemAudio;
                        streams.push(systemAudio);
                    }
                    if (this._captures.camera) {
                        const camera = await this._getUserMedia({ video: true, audio: this._captures.microphone })
                        streams.camera = camera
                        streams.isVideo = true
                        streams.push(camera);
                        hasCaptureMicrophone = this._captures.microphone;
                    }
                    if (!hasCaptureMicrophone && this._captures.microphone) {
                        const microphone = await this._getUserMedia({
                            audio: IsEdge() ? true : {
                                echoCancellation: false
                            }
                        })
                        streams.microphone = microphone
                        streams.push(microphone);
                    }
                    if (streams.screen && streams.camera) {
                        streams.screen.width = window.screen.width;
                        streams.screen.height = window.screen.height;
                        streams.screen.fullcanvas = true;
                        streams.camera.width = 320;
                        streams.camera.height = 240;
                        streams.camera.top = streams.screen.height - streams.camera.height;
                        streams.camera.left = streams.screen.width - streams.camera.width;
                    }

                    if (streamStopCallback) {
                        if (Array.isArray(streams)) {
                            streams.forEach(stream => this._addStreamStopListener(stream, streamStopCallback));
                        } else {
                            this._addStreamStopListener(streams, streamStopCallback);
                        }
                    }
                    return streams;
                } catch (e) {
                    alert('Error capturing streams: ' + e.message);
                    console.error(e);
                }
            }

            async _getUserMedia(constraints) {
                if (typeof navigator.mediaDevices === 'undefined' || !navigator.mediaDevices.getUserMedia) {
                    alert('This browser does not supports WebRTC getUserMedia API.');
                    throw new Error('getUserMedia is not supported by this browser');
                }
                return await navigator.mediaDevices.getUserMedia(constraints);
            }

            async _getDisplayMedia(constraints) {
                if (!navigator.getDisplayMedia && !navigator.mediaDevices.getDisplayMedia) {
                    alert('This browser does not supports WebRTC getDisplayMedia API.');
                    throw new Error('getDisplayMedia is not supported by this browser');
                }
                return await navigator.mediaDevices.getDisplayMedia(constraints);
            }

            _addStreamStopListener(stream, callback) {
                if (!stream || !callback) {
                    return;
                }
                stream.addEventListener('ended', function () {
                    callback();
                    callback = function () { };
                }, false);
                stream.addEventListener('inactive', function () {
                    callback();
                    callback = function () { };
                }, false);
                stream.getTracks().forEach(function (track) {
                    track.addEventListener('ended', function () {
                        callback();
                        callback = function () { };
                    }, false);
                    track.addEventListener('inactive', function () {
                        callback();
                        callback = function () { };
                    }, false);
                });
            }

            _saveURLToDisk(fileURL, ext, prefix = "redord-") {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0'); // 月份从0开始，需要加1
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                const fileName = prefix + formattedDateTime + '.' + ext;

                // for non-IE
                if (!window.ActiveXObject) {
                    let save = document.createElement('a');
                    save.href = fileURL;
                    save.download = fileName || 'unknown';
                    save.style = 'display:none;opacity:0;color:transparent;';
                    (document.body || document.documentElement).appendChild(save);
                    if (typeof save.click === 'function') {
                        save.click();
                    } else {
                        save.target = '_blank';
                        let event = document.createEvent('Event');
                        event.initEvent('click', true, true);
                        save.dispatchEvent(event);
                    }
                    (window.URL || window.webkitURL).revokeObjectURL(save.href);
                }
                // for IE
                else if (!!window.ActiveXObject && document.execCommand) {
                    let _window = window.open(fileURL, '_blank');
                    _window.document.close();
                    _window.document.execCommand('SaveAs', true, fileName || fileURL)
                    _window.close();
                }
            }

            _close() {
                if (!this._recordStreams) return;
                const callStop = (obj) => {
                    if (obj && typeof obj.stop === 'function') {
                        obj.stop();
                    }
                }
                callStop(this._recordStreams.camera);
                callStop(this._recordStreams.microphone);
                callStop(this._recordStreams.screen);
                callStop(this._recordStreams.systemAudio);
                if (Array.isArray(this.recordStreams)) {
                    for (const stream of this._recordStreams) {
                        callStop(stream)
                    }
                    callStop(this._recordStreams);
                    this._recordStreams = null;
                }
                if (this._recorder) {
                    this._recorder.destroy();
                    this._recorder = null;
                }
            };
        }
    </script>

    <script>
        const app = new MediaRecorderApp({
            captures: {
                //camera: true,
                //microphone: true,
                screen: true,
                systemAudio: true,
            },
            selectors: {
                start: '#btn-start-recording',
                stop: '#btn-stop-recording',
                pause: '#btn-pause-recording',
                resume: '#btn-resume-recording',
                download: '#btn-download-recording',
                videoRecordingPreview: 'video',
                videoFinishPreview: 'video',
                audioFinishPreview: 'audio'
            },
            notAttachSelectorsListeners: false
        });
    </script>
</body>

</html>